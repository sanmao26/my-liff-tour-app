<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0,viewport-fit=cover"
    />
    <title>My LIFF App</title>
    <style>
      body { padding: 24px; font-family: sans-serif; }
      button {
        display: none;
        width: 100%;
        padding: 16px 0;
        margin: 8px auto;
      }
    </style>
  </head>
  <body>
    <button id="btnShare" onclick="sendShare()">Share Target Picker</button>
    <button id="btnLogin" onclick="liff.login()">Log In</button>
    <button id="btnLogOut" onclick="logOut()">Log Out</button>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
      // === config ที่ต้องใช้ซ้ำ ===
      const LIFF_ID = "2006670623-loPapVk3";
      const AUTOSHARE_PARAM = "autoshare=1";
      const LIFF_AUTOSHARE_URL = `https://liff.line.me/${LIFF_ID}?${AUTOSHARE_PARAM}`;

      // --- Flex เดิม + เพิ่มปุ่ม "แชร์ต่อ" ใน footer ---
      function buildFlexBubble() {
        return {
  "type": "bubble",
  "size": "giga",
  "hero": {
    "type": "image",
    "url": "https://i.postimg.cc/RhtqmRHv/SL-31-68.jpg",
    "size": "full",
    "aspectRatio": "3:4",
    "aspectMode": "cover",
    "action": {
      "type": "uri",
      "uri": "https://www.probookingcenter.com/tours/japan"
    }
  }
}
        },
      }

      async function sendShare() {
        // กันพลาดกรณีรันบนเบราว์เซอร์ภายนอก/เวอร์ชันไม่รองรับ
        if (!liff.isApiAvailable("shareTargetPicker")) {
          // เปิด LIFF ตัวเองแทน (ให้ผู้ใช้กดแชร์จากในแอป)
          liff.openWindow({ url: LIFF_AUTOSHARE_URL, external: false });
          return;
        }

        const result = await liff.shareTargetPicker([
          {
            type: "flex",
            altText:
              "โปรตัดกรุ๊ปญี่ปุ่นไม่บวกเพิ่ม 25-33 คน ราคาเดิม วันนี้ - 30 ต.ค. 68",
            contents: buildFlexBubble()
          }
        ]);

        if (result) {
          alert(`[${result.status}] Message sent!`);
        } else {
          const [majorVer, minorVer, patchVer] = (liff.getLineVersion() || "").split(".");
          if (minorVer === undefined) {
            alert("ShareTargetPicker was canceled in external browser");
            return;
          }
          if (parseInt(majorVer) >= 10 && parseInt(minorVer) >= 10 && parseInt(patchVer) > 0) {
            alert("ShareTargetPicker was canceled in LINE app");
          }
        }
      }

      function logOut() {
        liff.logout();
        window.location.reload();
      }

      function hasAutoShareParam() {
        return window.location.search.replace("?", "").split("&").includes(AUTOSHARE_PARAM);
      }

      async function main() {
        await liff.init({ liffId: LIFF_ID });

        // โชว์ปุ่มตามสถานะ
        if (liff.isLoggedIn()) {
          document.getElementById("btnShare").style.display = "block";
          if (!liff.isInClient()) {
            document.getElementById("btnLogOut").style.display = "block";
          }
        } else {
          // ถ้าถูกเปิดมาด้วย ?autoshare=1 ให้บังคับล็อกอินแล้วกลับเข้ามา autoshare ต่อ
          if (hasAutoShareParam()) {
            liff.login({ redirectUri: window.location.href });
            return; // รอ redirect กลับมา
          }
          document.getElementById("btnLogin").style.display = "block";
        }

        // ถ้าอยู่ในแอป LINE และมีพารามิเตอร์ autoshare ให้เด้งแชร์ทันที
        if (liff.isLoggedIn() && liff.isInClient() && hasAutoShareParam()) {
          try {
            await sendShare();
          } catch (e) {
            console.error(e);
          }
        }
      }

      main();
    </script>
  </body>
</html>
