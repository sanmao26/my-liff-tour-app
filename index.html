<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0,viewport-fit=cover"
    />
    <title>My LIFF App</title>
    <style>
      body { padding: 256px; }
      button {
        display: none;
        width: 50%;
        padding: 16px 0;
        margin: 16px auto;
      }
    </style>
  </head>
  <body>
    <!-- ปุ่มเดิม เผื่อ user ยกเลิกการแชร์แล้วอยากกดส่งใหม่ -->
    <button id="btnShare" onclick="sendShare()">Share Target Picker</button>
    <button id="btnLogin" onclick="liff.login()">Log In</button>
    <button id="btnLogOut" onclick="logOut()">Log Out</button>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
      const DEFAULT_ALT_TEXT =
        "โปรตัดกรุ๊ปญี่ปุ่นไม่บวกเพิ่ม 25-33 คน ราคาเดิม วันนี้ - 30 ต.ค.68 ";

      // Flex เริ่มต้น (ใช้เมื่อไม่มี ?src= หรือ ?flex=)
      const DEFAULT_CONTENTS = {
        type: "bubble",
        size: "giga",
        hero: {
          type: "image",
          url: "https://i.postimg.cc/RhtqmRHv/SL-31-68.jpg",
          size: "full",
          aspectRatio: "3:4",
          aspectMode: "cover",
          action: {
            type: "uri",
            uri: "https://www.probookingcenter.com/tours/japan"
          }
        }
      };

      function logOut() {
        liff.logout();
        window.location.reload();
      }

      // ---- Helpers: ดึงพารามิเตอร์ & แปลง flex ----
      function getParams() {
        return new URLSearchParams(location.search);
      }

      function tryParseFlex(str) {
        if (!str) return null;
        // ลอง decodeURIComponent -> JSON
        try {
          return JSON.parse(decodeURIComponent(str));
        } catch (e) {}
        // ลอง base64 (รองรับ url-safe)
        try {
          const b64 = str.replace(/-/g, "+").replace(/_/g, "/");
          return JSON.parse(atob(b64));
        } catch (e) {}
        return null;
      }

      async function loadFlexContents() {
        const params = getParams();
        const src = params.get("src");
        const flexParam = params.get("flex");

        if (src) {
          try {
            const res = await fetch(src, { cache: "no-store" });
            return await res.json();
          } catch (e) {
            console.warn("โหลด src ไม่ได้ ใช้ DEFAULT แทน", e);
            return DEFAULT_CONTENTS;
          }
        }

        const parsed = tryParseFlex(flexParam);
        if (parsed) return parsed;

        return DEFAULT_CONTENTS;
      }

      // ---- แชร์ (auto-share) ----
      async function sendShare() {
        const params = getParams();
        const contents = await loadFlexContents();
        const altText = params.get("alt") || DEFAULT_ALT_TEXT;

        // ข้อความที่สองเป็นลิงก์ LIFF เพื่อให้ “ผู้รับแชร์ต่อได้” โดยไม่ต้องมีปุ่มใน Flex
        const noLink = params.get("nolink") === "1";
        const linkText =
          params.get("text") || `แชร์ต่อด้วยลิงก์นี้: ${location.href}`;

        const messages = [
          { type: "flex", altText, contents }
        ];

        if (!noLink) {
          messages.push({ type: "text", text: linkText });
        }

        const result = await liff.shareTargetPicker(messages);

        if (result) {
          // ส่งสำเร็จ: ปิดหน้าต่างให้จบ flow
          try { liff.closeWindow(); } catch (e) {}
        } else {
          // ผู้ใช้กดยกเลิก: โชว์ปุ่มให้กดแชร์ใหม่ได้
          const [majorVer, minorVer, patchVer] = (liff.getLineVersion() || "").split(".");
          if (minorVer === undefined) {
            alert("ShareTargetPicker ถูกยกเลิกในเบราว์เซอร์ภายนอก");
          } else if (parseInt(majorVer) >= 10 && parseInt(minorVer) >= 10 && parseInt(patchVer) > 0) {
            alert("ShareTargetPicker ถูกยกเลิกใน LINE app");
          }
          document.getElementById("btnShare").style.display = "block";
          if (!liff.isInClient()) {
            document.getElementById("btnLogOut").style.display = "block";
          }
        }
      }

      // ---- main: init แล้ว auto-login + auto-share ----
      async function main() {
        await liff.init({ liffId: "2006670623-loPapVk3" });

        if (!liff.isLoggedIn()) {
          // auto login เพื่อลดคลิก
          return liff.login({ redirectUri: location.href });
        }

        // เข้าสู่ระบบแล้ว -> แชร์ทันที
        await sendShare();
      }

      main();
    </script>
  </body>
</html>
