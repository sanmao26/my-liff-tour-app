<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0,viewport-fit=cover" />
  <title>‡πÅ‡∏ä‡∏£‡πå Flex & ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏ä‡∏£‡πå‡∏ï‡πà‡∏≠</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:0; padding:24px; }
    .wrap { max-width:720px; margin:0 auto; display:grid; gap:16px; }
    h1 { margin:0; font-size:clamp(18px,4vw,24px) }
    .card { border:1px solid #e5e7eb33; border-radius:14px; padding:16px; box-shadow:0 6px 20px #0001; }
    .row { display:flex; gap:8px; flex-wrap:wrap }
    button, a.btn { padding:12px 16px; border-radius:12px; border:0; font-weight:600; cursor:pointer; text-decoration:none; }
    .primary { background:#06c755; color:#fff }
    .ghost { background:transparent; border:1px solid #cbd5e1 }
    .muted { opacity:.85; font-size:14px; word-break:break-word }
    .hide { display:none }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>‡πÅ‡∏ä‡∏£‡πå Flex & ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏ä‡∏£‡πå‡∏ï‡πà‡∏≠</h1>

    <div class="card">
      <div class="row">
        <button id="btnShare" class="primary hide">‡πÅ‡∏ä‡∏£‡πå Flex ‡∏ï‡πà‡∏≠ (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏Å‡∏•‡∏∏‡πà‡∏°)</button>
        <button id="btnSendHere" class="ghost hide">‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤ ‚Äú‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‚Äù ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</button>
        <a id="btnOpenInLine" class="btn primary hide" href="#" rel="nofollow">‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ô LINE</a>
        <button id="btnCopy" class="ghost hide">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ä‡∏£‡πå</button>
      </div>
      <p id="env" class="muted"></p>
    </div>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    // ==== ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ ====
    const LIFF_ID = "2006670623-loPapVk3"; // LIFF ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    const ALT_TEXT = "‡πÇ‡∏õ‡∏£‡∏ï‡∏±‡∏î‡∏Å‡∏£‡∏∏‡πä‡∏õ‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô‡πÑ‡∏°‡πà‡∏ö‡∏ß‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏° 25‚Äì33 ‡∏Ñ‡∏ô ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏î‡∏¥‡∏° ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ - 30 ‡∏ï.‡∏Ñ. 68";

    // ----- Helper -----
    const $ = id => document.getElementById(id);
    const show = (id, on=true) => $(id).classList[on ? "remove":"add"]("hide");
    const qs = new URL(location.href).searchParams;
    const deepLink = () => `https://liff.line.me/${LIFF_ID}${location.search || ""}`; // ‡∏Ñ‡∏á‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÑ‡∏ß‡πâ (utm ‡∏Ø‡∏•‡∏Ø)

    function shareTextFallback(){
      const title = "‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô‡∏ó‡∏±‡∏ß‡∏£‡πå‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô 25‚Äì33 ‡∏Ñ‡∏ô ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏î‡∏¥‡∏°!";
      const landing = "https://www.probookingcenter.com/tours/japan";
      return `${title}\n‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ${landing}\n‡πÅ‡∏ä‡∏£‡πå‡∏ú‡πà‡∏≤‡∏ô LIFF: ${deepLink()}`;
    }
    function copyToClipboard(text){
      if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(()=>alert("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚úÖ"));
      } else {
        prompt("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°:", text);
      }
    }

    // ----- Flex ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå) -----
    function getFlex(){
      const landing = "https://www.probookingcenter.com/tours/japan";
      return {
        type: "bubble",
        size: "giga",
        hero: {
          type: "image",
          url: "https://i.postimg.cc/RhtqmRHv/SL-31-68.jpg",
          size: "full",
          aspectRatio: "3:4",
          aspectMode: "cover",
          action: { type: "uri", uri: landing }
        },
        body: { type:"box", layout:"vertical", spacing:"md", contents:[
          { type:"text", text:"‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô ‡∏Ñ‡∏±‡∏ô‡πÑ‡∏ã‚Äì‡πÄ‡∏Å‡∏µ‡∏¢‡∏ß‡πÇ‡∏ï‚Äì‡πÇ‡∏≠‡∏ã‡∏≤‡∏Å‡πâ‡∏≤", weight:"bold", size:"lg", wrap:true },
          { type:"text", text:"‡πÇ‡∏õ‡∏£‡∏ï‡∏±‡∏î‡∏Å‡∏£‡∏∏‡πä‡∏õ 25‚Äì33 ‡∏Ñ‡∏ô ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏î‡∏¥‡∏°", size:"sm", color:"#6b7280", wrap:true }
        ]},
        footer: { type:"box", layout:"vertical", spacing:"md", contents:[
          { type:"button", style:"primary", color:"#06c755",
            action:{ type:"uri", label:"‡∏î‡∏π‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°", uri: landing } },
          { type:"button", style:"secondary",
            action:{ type:"uri", label:"‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏ä‡∏£‡πå‡∏ï‡πà‡∏≠", uri: deepLink() } }
        ]}
      };
    }

    async function shareToMultiple(){
      if (!liff.isApiAvailable("shareTargetPicker")) {
        alert("‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á"); return;
      }
      try{
        const result = await liff.shareTargetPicker([{ type:"flex", altText: ALT_TEXT, contents: getFlex() }]);
        if (result) alert(`[${result.status}] ‡∏™‡πà‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ üéâ`);
      }catch(e){ alert("‡πÅ‡∏ä‡∏£‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + (e?.message||e)); }
    }

    async function sendToCurrentChat(){
      const ctx = liff.getContext?.();
      if (!['group','room','utou'].includes(ctx?.type)) {
        alert("‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏ï‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤ ‚Äò‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‚Äô"); return;
      }
      try{
        await liff.sendMessages([{ type:"flex", altText: ALT_TEXT, contents: getFlex() }]);
        alert("‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤ ‚Äò‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‚Äô ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚úÖ");
      }catch(e){ alert("‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + (e?.message||e)); }
    }

    async function init(){
      try { await liff.init({ liffId: LIFF_ID }); }
      catch(e){ alert("liff.init failed: " + (e?.message||e)); return; }

      const inClient = liff.isInClient();
      const loggedIn = liff.isLoggedIn();
      const ctxType = liff.getContext?.().type || "none";
      $("env").textContent = `inClient=${inClient} | loggedIn=${loggedIn} | context=${ctxType}`;

      // ‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏•‡∏±‡∏Å (‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ)
      $("btnShare").onclick = shareToMultiple;

      // ‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤ "‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ" (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡πÉ‡∏ô‡πÅ‡∏ä‡∏ï)
      $("btnSendHere").onclick = sendToCurrentChat;

      // Fallback: ‡πÄ‡∏õ‡∏¥‡∏î‡∏ô‡∏≠‡∏Å LINE / ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö ‚Üí ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏Ç‡πâ‡∏≤ LINE + ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
      $("btnOpenInLine").href = deepLink();
      $("btnCopy").onclick = () => copyToClipboard(shareTextFallback());

      if (inClient) {
        show("btnShare", true);              // ‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏Å‡∏î‡πÅ‡∏ä‡∏£‡πå‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ
        show("btnSendHere", ['group','room','utou'].includes(ctxType));
      } else {
        show("btnOpenInLine", true);
        show("btnCopy", true);
      }

      // ‡πÇ‡∏´‡∏°‡∏î auto ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏î‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏ä‡∏£‡πå (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£): ?autosend=1
      if (qs.get("autosend")==="1" && loggedIn && inClient) {
        try { await shareToMultiple(); } catch(_){}
      }
    }
    init();
  </script>
</body>
</html>
